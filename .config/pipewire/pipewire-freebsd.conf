# PipeWire configuration for FreeBSD with OSS support
#
# FreeBSD-specific configuration that enables OSS audio backend.
# Copy this file to ~/.config/pipewire/pipewire.conf.d/freebsd-oss.conf
# or use it as the main pipewire.conf
#
# The OSS SPA plugin (libspa-oss) should be installed via:
#   pkg install audio/pipewire
#   pkg install audio/wireplumber
#

context.properties = {
    # Core daemon settings
    core.daemon = true
    core.name   = pipewire-0

    # Audio settings optimized for low latency
    default.clock.rate          = 48000
    default.clock.allowed-rates = [ 44100 48000 96000 ]
    default.clock.quantum       = 1024
    default.clock.min-quantum   = 32
    default.clock.max-quantum   = 2048

    # FreeBSD VM overrides
    vm.overrides = {
        default.clock.min-quantum = 1024
    }

    # Enable D-Bus support if available
    support.dbus = true

    # Logging (increase for debugging)
    log.level = 2
}

context.spa-libs = {
    # Audio conversion
    audio.convert.* = audioconvert/libspa-audioconvert

    # FreeBSD OSS support - primary audio backend
    api.oss.*       = oss/libspa-oss

    # ALSA support (for compatibility, may not be used on FreeBSD)
    api.alsa.*      = alsa/libspa-alsa

    # Video support
    api.v4l2.*      = v4l2/libspa-v4l2

    # Bluetooth support
    api.bluez5.*    = bluez5/libspa-bluez5

    # Support libraries
    support.*       = support/libspa-support
}

context.modules = [
    # Realtime scheduling for better audio performance
    { name = libpipewire-module-rt
        args = {
            nice.level    = -11
            rt.prio       = 88
            rt.time.soft  = -1
            rt.time.hard  = -1
        }
        flags = [ ifexists nofail ]
    }

    # Native protocol for local connections
    { name = libpipewire-module-protocol-native }

    # Profiler for debugging and monitoring
    { name = libpipewire-module-profiler }

    # Metadata support
    { name = libpipewire-module-metadata }

    # SPA device factory - required for device enumeration
    { name = libpipewire-module-spa-device-factory }

    # SPA node factory - required for creating audio nodes
    { name = libpipewire-module-spa-node-factory }

    # Client node support
    { name = libpipewire-module-client-node }

    # Client device support
    { name = libpipewire-module-client-device }

    # Access control
    { name = libpipewire-module-access
        args = { }
    }

    # Adapter for format conversion
    { name = libpipewire-module-adapter }

    # Link factory for connecting nodes
    { name = libpipewire-module-link-factory }

    # Session manager support
    { name = libpipewire-module-session-manager }

    # X11 bell support (for desktop notifications)
    { name = libpipewire-module-x11-bell
        args = {
            #sink.name = "@DEFAULT_SINK@"
        }
        flags = [ ifexists nofail ]
    }
]

context.objects = [
    # Dummy driver for JACK clients and always-process nodes
    { factory = spa-node-factory
        args = {
            factory.name    = support.node.driver
            node.name       = Dummy-Driver
            node.group      = pipewire.dummy
            priority.driver = 20000
        }
    }

    # Freewheel driver for offline processing
    { factory = spa-node-factory
        args = {
            factory.name    = support.node.driver
            node.name       = Freewheel-Driver
            priority.driver = 19000
            node.group      = pipewire.freewheel
            node.freewheel  = true
        }
    }

    # OSS device enumeration - automatically discovers /dev/dsp* devices
    # Uncomment if WirePlumber doesn't auto-detect OSS devices
    #{ factory = spa-device-factory
    #    args = {
    #        factory.name = api.oss.enum
    #    }
    #}
]

context.exec = [
    # Session manager and PulseAudio compatibility are started separately
    # See bspwmrc.freebsd for startup commands
]
